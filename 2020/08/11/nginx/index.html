<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Nginx网站服务 |  我在人间凑数的日子
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?b67415e769cf821f4f0b7db65a16e914";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>



  <script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/d4088897.js","daovoice")
  daovoice('init', {
  app_id: "d4088897",
  });
  daovoice('update');
  </script>
<link rel="alternate" href="/atom.xml" title="我在人间凑数的日子" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-nginx" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Nginx网站服务
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/08/11/nginx/" class="article-date">
  <time datetime="2020-08-11T07:20:01.000Z" itemprop="datePublished">2020-08-11</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">8.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">34 分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="Nginx简介"><a href="#Nginx简介" class="headerlink" title="Nginx简介"></a>Nginx简介</h2><p>Nginx是一个高性能的 HTTP 和 反向代理 服务器,也是一个 IMAP/POP3/SMTP 服务器<br>Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler·ru站点（俄文：Рамблер）开发的,第一个公开版本0.1.0发布于2004年10月4日其将源代码以类BSD许可证的形式发布,因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名,2011年6月1日,nginx1.0.4发布<br>Nginx是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器,在BSD-like 协议下发行。其特点是占有内存少,并发能力强,事实上nginx的并发能力确实在同类型的网页服务器中表现较好。Nginx能够支持高达5万个并发连接的响应。</p>
<h2 id="Nginx的优点"><a href="#Nginx的优点" class="headerlink" title="Nginx的优点"></a>Nginx的优点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">低资源：占用内存小,可以实现高并发访问、处理响应快</span><br><span class="line">高并发：可抗高并发,Nginx支持的并发连接上限取决于你的内存</span><br><span class="line">作用：可以实现http服务器、虚拟主机、反向代理、负载均衡</span><br><span class="line">配置简单：Nginx配置简单</span><br><span class="line">安全: 可以不暴露真实服务器IP地址</span><br></pre></td></tr></table></figure>

<h2 id="Nginx负载均衡和lvs对比"><a href="#Nginx负载均衡和lvs对比" class="headerlink" title="Nginx负载均衡和lvs对比"></a>Nginx负载均衡和lvs对比</h2><p>lvs的优势</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、抗负载能力强,因为lvs工作方式的逻辑是非常之简单,而且工作在网络4层仅做请求分发之用,没有流量,所以在有效上基本不需要太过考虑,在我手里的lvs,仅仅出过一次问题：在并发最高的一小段时间内均衡器出现丢包现象,据分析为网络问题,即网卡或linux2.4内核的承载能力已到上线,内存和cpu方面基本无消耗。</span><br><span class="line">2、配置性低,这通常是一大劣势,但同时也是一大优势,因为没有太多可配置的选项,所以除了增减服务器,并不需要经常在触碰它,大大减少了人为出错的几率。</span><br><span class="line">3、工作稳定,因为其本身抗负载能力很强,所以稳定性高也是顺理成章,另外各种lvs都有完整的双机热备方案,所以一点不用担心均衡器本身会出现什么问题,节点出现故障的话,lvs会自动判别,所以系统整体是非常稳定的</span><br><span class="line">4、无流量,上面已经有所提及了,lvs仅仅分发请求,而流量并不从它本身出去,所以可以利用它这点来做一些线路分流之用。没有流量同时也是保住了均衡器的IO性能不会受到大流量的影响</span><br><span class="line">5、基本上能支持所有应用,因为lvs工作在4层,所以它可以对几乎所有应用做负载均衡,包括http、数据库、聊天室等等。</span><br><span class="line">另：lvs也不是完全能判别节点故障的,譬如在wlc分配方式下,集群里有一个节点没有配置VIP,会使整个集群不能使用,这时使用wrr分配方式则会丢掉一台机,目前这个问题还在进一步测试中,所以,用lvs也得多多当心为妙</span><br></pre></td></tr></table></figure>
<p>nginx对比lvs的优势</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、nginx工作在网络的7层,所以它可以针对http应用 本身来做分流策略,比如针对域名、目录结构等,相比之下lvs并不具备这样的功能,所以nginx单凭这点可利用的场合就远多于lvs了。但nginx有用的这些功能使其可调整度要高于lvs,所以经常要去触碰触碰,由lvs的第2条优点看,触碰多了。人为出问题的记录也就会大。</span><br><span class="line">2、nginx对网络的依赖较小,理论上只要ping得通,网页访问正常,nginx就能连得通,nginx同时还能区分内外网,如果是同时拥有内外网的 节点,就相当于单机拥有了备份线路；lvs就比较依赖于网络环境,目前来看服务器在同一网段内并且lvs使用direct方式分流,效果较能得到保证。另 外注意,lvs需要向托管商至少申请多一个ip来做Visual IP,貌似是不能用本身的IP来做VIP的。要做好LVS管理员,确实得跟进学习很多有关网络通信方面的知识,就不再是一个HTTP那么简单了。</span><br><span class="line">3、nginx安装和配置比较简单,测试起来也很方便,因为它基本能把错误用日志打印出来。lvs的安装和配置、测试就要花比较长的时间了,因为同上所述,lvs对网络依赖比较大,很多时候不能配置成功都是因为网络问题而不是配置问题,出了问题要解决也相应的会麻烦得多。</span><br><span class="line">4、nginx也同样能承受很高负载且稳定,但负载度和稳定度差lvs还有几个等级：nginx处理所有流量所以受限于机器IO和配置；本身的bug也还是难以避免的；nginx没有现成的双机热备方案,所以跑在单机上还是风险较大,单机上的事情全都很难说。</span><br><span class="line">5、nginx可以检测到服务器内部的故障,比如根据服务器处理网页返回的状态码、超时等等,并且会把返回错误的请求重新提交到另一个节点。目前lvs中 ldirectd也能支持针对服务器内部的情况来监控,但lvs的原理使其不能重发请求。重发请求这点,譬如用户正在上传一个文件,而处理该上传的节点刚 好在上传过程中出现故障,nginx会把上传切到另一台服务器重新处理,而lvs就直接断掉了,如果是上传一个很大的文件或者很重要的文件的话,用户可能 会因此而恼火。</span><br><span class="line">6、nginx对请求的异步处理可以帮助节点服务器减轻负载,假如使用apache直接对外服务,那么出现很多的窄带链接时apache服务器将会占用大 量内存而不能释放,使用多一个nginx做apache代理的话,这些窄带链接会被nginx挡住,apache上就不会堆积过多的请求,这样就减少了相 当多的内存占用。这点使用squid也有相同的作用,即使squid本身配置为不缓存,对apache还是有很大帮助的。lvs没有这些功能,也就无法能 比较。</span><br><span class="line">7、nginx能支持http和email（email的功能估计比较少人用）,lvs所支持的应用在这点上会比nginx更多。</span><br></pre></td></tr></table></figure>
<h2 id="特点对比"><a href="#特点对比" class="headerlink" title="特点对比"></a>特点对比</h2><p>LVS特点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.抗负载能力强,使用IP负载均衡技术,只做分发,所以LVS本身并没有多少流量产生；</span><br><span class="line">2.稳定性、可靠性好,自身有完美的热备方案；（如：LVS+Keepalived）</span><br><span class="line">3.应用范围比较广,可以对所有应用做负载均衡；</span><br><span class="line">4.不支持正则处理,不能做动静分离。</span><br><span class="line"></span><br><span class="line">常用四种算法：</span><br><span class="line"></span><br><span class="line">1.rr：轮询,轮流分配到后端服务器；</span><br><span class="line">2.wrr：权重轮询,根据后端服务器负载情况来分配；</span><br><span class="line">3.lc：最小连接,分配已建立连接最少的服务器上；</span><br><span class="line">4.wlc：权重最小连接,根据后端服务器处理能力来分配。</span><br><span class="line">可以采用ipvsadm –p（persistence）来保持session,默认是300/s</span><br></pre></td></tr></table></figure>
<p>Nginx特点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.工作在7层,可以对做正则规则处理；（如：针对域名、目录进行分流）</span><br><span class="line">2.配置简单,能ping通就能进行负载功能,可以通过端口检测后端服务器状态,不支持url检测；</span><br><span class="line">3.抗高并发,采用epoll网络模型处理客户请求；</span><br><span class="line">4.只支持HTTP和EMail,应用范围比较少；</span><br><span class="line">5.nginx主要是HTTP和反向代理服务器,低系统资源消耗。</span><br><span class="line"></span><br><span class="line">常用四种算法：</span><br><span class="line"></span><br><span class="line">1.RR：（默认）轮询,轮流分配到后端服务器；</span><br><span class="line">2.weight：根据后端服务器性能分配；</span><br><span class="line">3.ip_hash：每个请求按访问ip的<span class="built_in">hash</span>结果进行分配,并发小时合适,解决session问题；</span><br><span class="line">4.fair：（扩展策略）,默认不被编译nginx内核,根据后端服务器响应时间判断负载情况,选择最轻的进行处理。</span><br></pre></td></tr></table></figure>
<p>为什么用Nginx而不用LVS?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、高并发连接： 官方测试能够支撑5万并发连接,在实际生产环境中跑到 2~3 万并发连接数。</span><br><span class="line">2、内存消耗少： 在 3 万并发连接下,开启的 10 个 Nginx 进程才消耗 150M 内存（ 15M*10=150M ）。</span><br><span class="line">3、配置文件非常简单： 风格跟程序一样通俗易懂。</span><br><span class="line">4、成本低廉： Nginx 为开源软件,可以免费使用。而购买 F5 BIG-IP、NetScaler 等硬件负载均衡交换机则需要十多万至几十万人民币。</span><br><span class="line">  使用 Nginx 做七层负载均衡的理由?</span><br><span class="line">5、支持 Rewrite 重写规则： 能够根据域名、 URL 的不同,将 HTTP 请求分到不同的后端服务器群组。</span><br><span class="line">6、内置的健康检查功能： 如果 Nginx Proxy 后端的某台 Web 服务器宕机了,不会影响前端访问。</span><br><span class="line">7、节省带宽： 支持 GZIP 压缩,可以添加浏览器本地缓存的 Header 头。</span><br></pre></td></tr></table></figure>
<h2 id="Nginx安装部署"><a href="#Nginx安装部署" class="headerlink" title="Nginx安装部署"></a>Nginx安装部署</h2><p>nginx官网下载地址：<a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖工具包</span></span><br><span class="line">yum install  gcc*   c++*    pcre  pcre-devel  openssl  openssl-devel  -y</span><br><span class="line"><span class="comment"># 下载源码包</span></span><br><span class="line">wget  http://nginx.org/download/nginx-1.18.0.tar.gz</span><br><span class="line"><span class="comment"># 解压编译安装</span></span><br><span class="line">tar xf  nginx-1.18.0.tar.gz  -C /usr/src/</span><br><span class="line"><span class="built_in">cd</span>  /usr/src/nginx-1.18.0/</span><br><span class="line">./configure    --prefix=/usr/<span class="built_in">local</span>/nginx</span><br><span class="line">make   &amp;&amp; make  install  </span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin</span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">./nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes auto; （默认为自动,可以自己设置,一般不大于cpu核数）</span><br><span class="line">error_log /var/<span class="built_in">log</span>/nginx/error.log; （错误日志路径）</span><br><span class="line">pid /run/nginx.pid; （pid文件路径）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    accept_mutex on; （设置网路连接序列化,防止惊群现象发生,默认为on）</span><br><span class="line">    multi_accept on; （设置一个进程是否同时接受多个网络连接,默认为off）</span><br><span class="line">    worker_connections 1024; （一个进程的最大连接数）</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">      <span class="comment"># 设置日志格式</span></span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    <span class="comment"># tcp_nopush          on; （这里注释掉）</span></span><br><span class="line">    tcp_nodelay        on;</span><br><span class="line">    keepalive_timeout  65; （连接超时时间）</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    gzip on; （开启压缩）</span><br><span class="line">    include            /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span></span><br><span class="line">    <span class="comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span></span><br><span class="line">    <span class="comment"># for more information.</span></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里设置负载均衡,负载均衡有多中策略,nginx自带的有轮询,权重,ip-hash,响应时间等粗略。</span></span><br><span class="line"><span class="comment"># 默认为平分http负载,为轮询的方式。</span></span><br><span class="line"><span class="comment"># 权重则是按照权重来分发请求,权重高的负载大</span></span><br><span class="line"><span class="comment"># ip-hash,根据ip来分配,保持同一个ip分在同一台服务器上。</span></span><br><span class="line"><span class="comment"># 响应时间,根据服务器都nginx 的响应时间,优先分发给响应速度快的服务器。</span></span><br><span class="line"><span class="comment"># 集中策略可以适当组合</span></span><br><span class="line">    upstream tomcat &#123; （tomcat为自定义的负载均衡规则名）</span><br><span class="line">        ip_hash; （ip_hash则为ip-hash方法）</span><br><span class="line"></span><br><span class="line">　　　　　　server 192.168.2.78:80 weight=3 fail_timeout=20s;</span><br><span class="line">　　　　　　server 192.168.2.82:80 weight=4 fail_timeout=20s;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 可以定义多组规则</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen      80 default_server; （默认监听80端口）</span><br><span class="line">        listen      localhost; （监听的服务器）</span><br><span class="line">        server_name  _;</span><br><span class="line">        root        /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load configuration files for the default server block.</span></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location / &#123; （ /  表示所有请求,可以自定义来针对不同的域名设定不同负载规则 和服务）</span><br><span class="line">          proxy_pass    http://tomcat; （反向代理,填上你自己的负载均衡规则名）</span><br><span class="line">          proxy_redirect off; （下面一些设置可以直接复制过去,不要的话,有可能导致一些 没法认证等的问题）</span><br><span class="line">          proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">          proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">          proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">          proxy_connect_timeout 90; （下面这几个都只是一些超时设置,可不要）</span><br><span class="line">          proxy_send_timeout 90;</span><br><span class="line">          proxy_read_timeout 90;</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="comment"># location ~\.(gif|jpg|png)$ &#123; （比如,以正则表达式写） </span></span><br><span class="line">  <span class="comment">#  root /home/root/images;</span></span><br><span class="line">  <span class="comment">#  &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings for a TLS enabled server.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    server &#123;</span></span><br><span class="line"><span class="comment">#        listen      443 ssl http2 default_server;</span></span><br><span class="line"><span class="comment">#        listen      [::]:443 ssl http2 default_server;</span></span><br><span class="line"><span class="comment">#        server_name  _;</span></span><br><span class="line"><span class="comment">#        root        /usr/share/nginx/html;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        ssl_certificate "/etc/pki/nginx/server.crt";</span></span><br><span class="line"><span class="comment">#        ssl_certificate_key "/etc/pki/nginx/private/server.key";</span></span><br><span class="line"><span class="comment">#        ssl_session_cache shared:SSL:1m;</span></span><br><span class="line"><span class="comment">#        ssl_session_timeout  10m;</span></span><br><span class="line"><span class="comment">#        ssl_ciphers HIGH:!aNULL:!MD5;</span></span><br><span class="line"><span class="comment">#        ssl_prefer_server_ciphers on;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        # Load configuration files for the default server block.</span></span><br><span class="line"><span class="comment">#        include /etc/nginx/default.d/*.conf;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        location / &#123;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        error_page 404 /404.html;</span></span><br><span class="line"><span class="comment">#            location = /40x.html &#123;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        error_page 500 502 503 504 /50x.html;</span></span><br><span class="line"><span class="comment">#            location = /50x.html &#123;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行用户</span></span><br><span class="line">user www-data;    </span><br><span class="line"><span class="comment">#启动进程,通常设置成和cpu的数量相等</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"> <span class="comment">#全局错误日志及PID文件</span></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"> <span class="comment">#工作模式及连接数上限</span></span><br><span class="line">events &#123;</span><br><span class="line">    use   epoll;             <span class="comment">#epoll是多路复用IO(I/O Multiplexing)中的一种方式,但是仅用于linux2.6以上内核,可以大大提高nginx的性能</span></span><br><span class="line">    worker_connections  1024;<span class="comment">#单个后台worker process进程的最大并发链接数</span></span><br><span class="line">    <span class="comment"># multi_accept on; </span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">#设定http服务器,利用它的反向代理功能提供负载均衡支持</span></span><br><span class="line">http &#123;</span><br><span class="line">     <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    access_log    /var/<span class="built_in">log</span>/nginx/access.log;</span><br><span class="line">   <span class="comment">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件,对于普通应用,</span></span><br><span class="line">    <span class="comment">#必须设为 on,如果用来进行下载等应用磁盘IO重负载应用,可设置为 off,以平衡磁盘与网络I/O处理速度,降低系统的uptime.</span></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    <span class="comment">#连接超时时间</span></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    tcp_nodelay        on;</span><br><span class="line">     <span class="comment">#开启gzip压缩</span></span><br><span class="line">    gzip  on;</span><br><span class="line">    gzip_disable <span class="string">"MSIE [1-6]\.(?!.*SV1)"</span>;</span><br><span class="line">    <span class="comment">#设定请求缓冲</span></span><br><span class="line">    client_header_buffer_size    1k;</span><br><span class="line">    large_client_header_buffers  4 4k;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    include /etc/nginx/sites-enabled/*;</span><br><span class="line">    <span class="comment">#设定负载均衡的服务器列表</span></span><br><span class="line">     upstream mysvr &#123;</span><br><span class="line">    <span class="comment">#weigth参数表示权值,权值越高被分配到的几率越大</span></span><br><span class="line">    <span class="comment">#本机上的Squid开启3128端口</span></span><br><span class="line">    server 192.168.8.1:3128 weight=5;</span><br><span class="line">    server 192.168.8.2:80  weight=1;</span><br><span class="line">    server 192.168.8.3:80  weight=6;</span><br><span class="line">    &#125;</span><br><span class="line">   server &#123;</span><br><span class="line">    <span class="comment">#侦听80端口</span></span><br><span class="line">        listen       80;</span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        server_name  www.xx.com;</span><br><span class="line">        <span class="comment">#设定本虚拟主机的访问日志</span></span><br><span class="line">        access_log  logs/www.xx.com.access.log  main;</span><br><span class="line">    <span class="comment">#默认请求</span></span><br><span class="line">    location / &#123;</span><br><span class="line">          root   /root;      <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">          index index.php index.html index.htm;   <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">          fastcgi_pass  www.xx.com;</span><br><span class="line">          fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span>/<span class="variable">$fastcgi_script_name</span>; 脚本文件请求的路径</span><br><span class="line">          include /etc/nginx/fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment"># 定义错误提示页面</span></span><br><span class="line">    error_page   500 502 503 504 /50x.html;  </span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">        root   /root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#静态文件,nginx自己处理</span></span><br><span class="line">    location ~ ^/(images|javascript|js|css|flash|media|static)/ &#123;</span><br><span class="line">        root /var/www/virtual/htdocs;</span><br><span class="line">        <span class="comment">#过期30天,静态文件不怎么更新,过期可以设大一点,如果频繁更新,则可以设置得小一点。</span></span><br><span class="line">        expires 30d;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.</span></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root /root;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME /home/www/www<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#设定查看Nginx状态的地址</span></span><br><span class="line">    location /NginxStatus &#123;</span><br><span class="line">        stub_status            on;</span><br><span class="line">        access_log              on;</span><br><span class="line">        auth_basic              <span class="string">"NginxStatus"</span>;</span><br><span class="line">        auth_basic_user_file  conf/htpasswd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#禁止访问 .htxxx 文件</span></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>虚拟主机是使用特殊的软硬件技术,把一台真实的物理服务器主机分割成多个逻辑存储单元。每个逻辑单元都没有物理实体,但是每一个逻辑单元都能像真实的物理主机一样在网络上工作,具有单独的IP地址（或共享的IP地址）、独立的域名以及完整的Internet服务器（支持WWW、FTP、E-mail等）功能。<br>虚拟主机的关键技术在于,即使在同一台硬件、同一个操作系统上,运行着为多个用户打开的不同的服务器程式,也互不干扰。而各个用户拥有自己的一部分系统资源（IP地址、文档存储空间、内存、CPU等）。各个虚拟主机之间完全独立,在外界看来,每一台虚拟主机和一台单独的主机的表现完全相同。所以这种被虚拟化的逻辑主机被形象地称为”虚拟主机”</p>
<h3 id="基于端口的虚拟主机"><a href="#基于端口的虚拟主机" class="headerlink" title="基于端口的虚拟主机"></a>基于端口的虚拟主机</h3><p>修改nginx.conf (server 配置段需要添加在http配置段中)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /webdate/<span class="built_in">test</span>;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       8090;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /webdata/test1;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检测配置文件是否正确</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># ./nginx  -t            </span></span><br><span class="line">nginx: the configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure>
<p>重启nginx并且测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># echo  "port is 80" &gt; /webdata/test/index.html </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># echo  "port is 8090" &gt; /webdata/test1/index.html </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># lsof -i:80</span></span><br><span class="line">COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx   46506   root    6u  IPv4 695380      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   46507 nobody    6u  IPv4 695380      0t0  TCP *:http (LISTEN)</span><br><span class="line">[root@localhost sbin]<span class="comment"># kill -9  46506 46507</span></span><br><span class="line">[root@localhost sbin]<span class="comment"># ./nginx </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># elinks  http://localhost:80   -dump  </span></span><br><span class="line">   port is 80</span><br><span class="line">[root@localhost sbin]<span class="comment"># elinks  http://localhost:8090   -dump  </span></span><br><span class="line">   port is 8090</span><br><span class="line">[root@localhost sbin]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="基于IP的虚拟主机"><a href="#基于IP的虚拟主机" class="headerlink" title="基于IP的虚拟主机"></a>基于IP的虚拟主机</h3><p>首先保证服务器有两个ip地址,实验环境是虚拟机直接添加个网络适配器配置下ip就可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.89  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 fe80::e9b6:bbdd:9d72:9e0a  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:cb:96:c9  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 1111  bytes 138751 (135.4 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 247  bytes 41089 (40.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens37: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.110  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 fe80::326:4059:a69b:80c  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:cb:96:d3  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 872  bytes 106472 (103.9 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 12  bytes 1176 (1.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 13  bytes 965 (965.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 13  bytes 965 (965.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>配置nginx.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim ../conf/nginx.conf</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       192.168.1.89:80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /webdata/<span class="built_in">test</span>;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       192.168.1.110:80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /webdata/test1;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>重启nginx并且测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># echo   "192.168.1.89" &gt; /webdata/test/index.html </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># echo "192.168.1.110" &gt; /webdata/test1/index.html </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># lsof -i:80</span></span><br><span class="line">COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx   46506   root    6u  IPv4 695380      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   46507 nobody    6u  IPv4 695380      0t0  TCP *:http (LISTEN)</span><br><span class="line">[root@localhost sbin]<span class="comment"># kill -9  46506 46507</span></span><br><span class="line">[root@localhost sbin]<span class="comment"># ./nginx </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># elinks  http://192.168.1.89:80   -dump            </span></span><br><span class="line">   192.168.1.89</span><br><span class="line">[root@localhost sbin]<span class="comment"># elinks  http://192.168.1.110:80   -dump   </span></span><br><span class="line">   192.168.1.110</span><br><span class="line">[root@localhost sbin]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="基于域名的虚拟主机"><a href="#基于域名的虚拟主机" class="headerlink" title="基于域名的虚拟主机"></a>基于域名的虚拟主机</h3><p>修改/etc/hosts文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">    192.168.1.89  www.xin.com</span><br><span class="line">    192.168.1.89  www.long.com</span><br></pre></td></tr></table></figure>
<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.xin.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /webdata/<span class="built_in">test</span>;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.long.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /webdata/test1;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启nginx并且测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># echo   "www.xin.com" &gt; /webdata/test/index.html </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># echo "www.long.com" &gt; /webdata/test1/index.html </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># lsof -i:80</span></span><br><span class="line">COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx   46506   root    6u  IPv4 695380      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   46507 nobody    6u  IPv4 695380      0t0  TCP *:http (LISTEN)</span><br><span class="line">[root@localhost sbin]<span class="comment"># kill -9  46506 46507</span></span><br><span class="line">[root@localhost sbin]<span class="comment"># ./nginx </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># elinks  http://www.xin.com:80   -dump                 </span></span><br><span class="line">   www.xin.com</span><br><span class="line">[root@localhost sbin]<span class="comment"># elinks  http://www.long.com:80   -dump   </span></span><br><span class="line">   www.long.com</span><br><span class="line">[root@localhost sbin]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="nginx认证配置"><a href="#nginx认证配置" class="headerlink" title="nginx认证配置"></a>nginx认证配置</h2><p>nginx basic auth指令<br>    语法:     auth_basic string | off;<br>    默认值:     auth_basic off;<br>    配置段:     http, server, location, limit_except<br>    默认表示不开启认证,后面如果跟上字符,这些字符会在弹窗中显示。<br>    语法:     auth_basic_user_file file;<br>    默认值:     —<br>    配置段:     http, server, location, limit_except<br>    用户密码文件,文件内容类似如下：<br>    ttlsauser1:password1<br>    ttlsauser2:password2:comment<br>生成密码文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon sbin]<span class="comment"># htpasswd  -cm   /usr/local/nginx/.htpasswd   test</span></span><br><span class="line">New password:        <span class="comment"># 输入密码</span></span><br><span class="line">Re-type new password:     <span class="comment"># 确认密码</span></span><br><span class="line">Adding password <span class="keyword">for</span> user <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>nginx认证配置实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.xin.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /webdata/<span class="built_in">test</span>;    <span class="comment"># 加密的目录</span></span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        auth_basic  <span class="string">"nginx basic http test for ttlsa.com"</span>;    <span class="comment"># 描述文件</span></span><br><span class="line">        auth_basic_user_file  /usr/<span class="built_in">local</span>/nginx/.htpasswd;     <span class="comment"># 密码文件</span></span><br><span class="line">        autoindex  on;    <span class="comment"># 是否开启</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon sbin]<span class="comment"># ./nginx  -t</span></span><br><span class="line">nginx: the configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure>
<p>访问网站<br><img src="/2020/08/11/nginx/1.png" alt><br>提示需要输入密码<br><img src="/2020/08/11/nginx/2.png" alt><br>备注：一定要注意auth_basic_user_file路径,否则会不厌其烦的出现403</p>
<h2 id="nginx-网站限速"><a href="#nginx-网站限速" class="headerlink" title="nginx 网站限速"></a>nginx 网站限速</h2><p>配置项：limit_rate_after<br>   当一个客户端连接后,将以最快的速度下载多大文件,然后在以限制速度下载文件<br>   该指令是下载字节量的大小值,而不是时间值<br>   当一个客户端连接后,将以最快的速度下载3M,然后再以大约10k的速度下载</p>
<p>实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">                listen 80;</span><br><span class="line">                server_name www.domain.com;</span><br><span class="line">                location / &#123;</span><br><span class="line">                        root /tmp/186;</span><br><span class="line">                        index index.html;</span><br><span class="line">                        limit_rate 10k;  <span class="comment"># 下载速度</span></span><br><span class="line">                        limit_rate_after 3m;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/11/nginx/11.png" alt><br><img src="/2020/08/11/nginx/12.png" alt><br><img src="/2020/08/11/nginx/13.png" alt><br><img src="/2020/08/11/nginx/14.png" alt><br><img src="/2020/08/11/nginx/15.png" alt><br><img src="/2020/08/11/nginx/16.png" alt><br><img src="/2020/08/11/nginx/17.png" alt></p>
<p>配置项：limit_rate<br>    是指定向客户端传输数据的速度,单位是每秒传输的字节数<br>    该限制只针对一个连接的设定,如果同时两个连接数,那么速度是设置值的两倍<br>limit_rate_after<br>   当一个客户端连接后,将以最快的速度下载多大文件,然后在以限制速度下载文件<br>   该指令是下载字节量的大小值,而不是时间值<br>   当一个客户端连接后,将以最快的速度下载3M,然后再以大约10k的速度下载</p>
<h2 id="nginx-区域配置规则"><a href="#nginx-区域配置规则" class="headerlink" title="nginx 区域配置规则"></a>nginx 区域配置规则</h2><h3 id="Location规则"><a href="#Location规则" class="headerlink" title="Location规则"></a>Location规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">语法规则： location [=|~|~*|^~] /url/ &#123;… &#125;</span><br><span class="line">匹配顺序： ＝／ ／  ^~   ~*</span><br><span class="line">符号含义</span><br><span class="line">=</span><br><span class="line">= 开头表示精确匹配</span><br><span class="line">^~</span><br><span class="line">^~开头表示uri以某个常规字符串开头,理解为匹配 url路径即可。nginx不对url做编码,因此请求为/static/20%/aa,可以被规则^~ /static/ /aa匹配到（注意是空格）</span><br><span class="line">~</span><br><span class="line">~ 开头表示区分大小写的正则匹配</span><br><span class="line">~*</span><br><span class="line">~* 开头表示不区分大小写的正则匹配</span><br><span class="line">!~和!~*</span><br><span class="line">!~和!~*分别为区分大小写不匹配及不区分大小写不匹配的正则</span><br><span class="line">/</span><br><span class="line">用户所使用的代理（一般为浏览器）</span><br><span class="line"><span class="variable">$http_x_forwarded_for</span></span><br><span class="line">可以记录客户端IP,通过代理服务器来记录客户端的ip地址</span><br><span class="line"><span class="variable">$http_referer</span></span><br><span class="line">可以记录用户是从哪个链接访问过来的</span><br></pre></td></tr></table></figure>
<h3 id="匹配规则示例："><a href="#匹配规则示例：" class="headerlink" title="匹配规则示例："></a>匹配规则示例：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;  </span><br><span class="line">    <span class="comment">#规则A  </span></span><br><span class="line">&#125;  </span><br><span class="line">location = /login &#123;  </span><br><span class="line">    <span class="comment">#规则B  </span></span><br><span class="line">&#125;  </span><br><span class="line">location ^~ /static/ &#123;  </span><br><span class="line">    <span class="comment">#规则C  </span></span><br><span class="line">&#125;  </span><br><span class="line">location ~ \.(gif|jpg|png|js|css)$ &#123;  </span><br><span class="line">    <span class="comment">#规则D  </span></span><br><span class="line">&#125;  </span><br><span class="line">location ~* \.png$ &#123;  </span><br><span class="line">    <span class="comment">#规则E  </span></span><br><span class="line">&#125;  </span><br><span class="line">location !~ \.xhtml$ &#123;  </span><br><span class="line">    <span class="comment">#规则F  </span></span><br><span class="line">&#125;  </span><br><span class="line">location !~* \.xhtml$ &#123;  </span><br><span class="line">    <span class="comment">#规则G  </span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">那么产生的效果如下：</span><br><span class="line">1. 访问根目录/,比如http://localhost/将匹配规则A</span><br><span class="line">2. 访问 http://localhost/login 将匹配规则B,</span><br><span class="line">3. 访问 http://localhost/static/a.html 将匹配规则C</span><br><span class="line">4. 访问 http://localhost/a.gif,http://localhost/b.jpg 将匹配规则D和规则E,但是规则D顺序优先,规则E不起作用,而http://localhost/static/c.png则优先匹配到规则C</span><br><span class="line">5. 访问 http://localhost/a.PNG 则匹配规则E,而不会匹配规则D,因为规则E不区分大小写。</span><br><span class="line">6. 访问 http://localhost/a.xhtml 不会匹配规则F和规则G,http://localhost/a.XHTML不会匹配规则G,因为不区分大小写。规则F,规则G属于排除法,符合匹配规则但是不会匹配到,所以想想看实际应用中哪里会用到。</span><br><span class="line">7. 访问 http://localhost/category/id/1111 则最终匹配到规则H,因为以上规则都不匹配,这个时候应该是nginx转发请求给后端应用服务器,比如FastCGI（php）,tomcat（jsp）,nginx作为方向代理服务器存在。</span><br></pre></td></tr></table></figure>
<h3 id="实际常用规则"><a href="#实际常用规则" class="headerlink" title="实际常用规则"></a>实际常用规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接匹配网站根,通过域名访问网站首页比较频繁,使用这个会加速处理。</span></span><br><span class="line"><span class="comment">#这里是直接转发给后端应用服务器了,也可以是一个静态首页</span></span><br><span class="line"><span class="comment"># 第一个必选规则</span></span><br><span class="line">[plain] view plain copy</span><br><span class="line">location = / &#123;  </span><br><span class="line">   proxy_pass  http://tomcat:8080/index  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第二个必选规则是处理静态文件请求,这是nginx作为http服务器的强项</span></span><br><span class="line"><span class="comment"># 有两种配置模式,目录匹配或后缀匹配,任选其一或搭配使用</span></span><br><span class="line">[plain] view plain copy</span><br><span class="line">    location ^~ /static/ &#123;  </span><br><span class="line">       <span class="comment"># 请求/static/a.txt 将被映射到实际目录文件:/webroot/res/static/a.txt  </span></span><br><span class="line">       root /webroot/res/;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    location ~* \.(gif|jpg|jpeg|png|css|js|ico)$&#123;  </span><br><span class="line">       root /webroot/res/;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第三个规则就是通用规则,用来转发动态请求到后端应用服务器</span></span><br><span class="line"><span class="comment">#非静态文件请求就默认是动态请求,自己根据实际把握</span></span><br><span class="line"><span class="comment">#毕竟目前的一些框架的流行,带.php,.jsp后缀的情况很少了</span></span><br><span class="line"></span><br><span class="line">[plain] view plain copy</span><br><span class="line">location / &#123;  </span><br><span class="line">   proxy_pass http://tomcat:8080/  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Location解析过程"><a href="#Location解析过程" class="headerlink" title="Location解析过程"></a>Location解析过程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">先判断精准命中,如果命中,立即返回结果并结束解析过程。</span><br><span class="line">判断普通命中,如果有多个命中,“记录”下来“最长”的命中结果（记录但不结束,最长的为准）。</span><br><span class="line">继续判断正则表达式的解析结果,按配置里的正则表达式顺序为准,由上至下开始匹配,一旦匹配成功1个,立即返回结果,并结束解析过程。</span><br><span class="line">普通命中顺序无所谓,是因为按命中的长短来确定。正则命中,顺序有所谓,因为是从前入往后命中的。</span><br></pre></td></tr></table></figure>

<h3 id="rewrite语法"><a href="#rewrite语法" class="headerlink" title="rewrite语法"></a>rewrite语法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Nginx提供的全局变量或自己设置的变量,结合正则表达式和标志位实现url重写以及重定向。</span><br><span class="line">rewrite只能放在server&#123;&#125;,location&#123;&#125;,<span class="keyword">if</span>&#123;&#125;中,并且只能对域名后边的除去传递的参数外的字符串起作用。</span><br><span class="line">Rewrite主要的功能就是实现URL的重写,Nginx的Rewrite规则采用Pcre,perl兼容正则表达式的语法规则匹配,如果需要Nginx的Rewrite功能,在编译Nginx之前,需要编译安装PCRE库。</span><br><span class="line">通过Rewrite规则,可以实现规范的URL、根据变量来做URL转向及选择配置</span><br></pre></td></tr></table></figure>
<h3 id="rewrite相关指令"><a href="#rewrite相关指令" class="headerlink" title="rewrite相关指令"></a>rewrite相关指令</h3><table>
<thead>
<tr>
<th align="center">指令</th>
<th align="center">默认值</th>
<th align="center">适用范围</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">break</td>
<td align="center">none</td>
<td align="center">if,server,location</td>
<td align="center">完成当前规则集,不再处理rewrite指令,需要和last加以区分</td>
</tr>
<tr>
<td align="center">if ( condition ) <br>{ … }</td>
<td align="center">none</td>
<td align="center">server,location</td>
<td align="center">用于检测一个条件是否符合,符合则执行大括号内的语句。不支持嵌套,不支持多个条件&amp;&amp;或</td>
</tr>
<tr>
<td align="center">return</td>
<td align="center">none</td>
<td align="center">server,if,location</td>
<td align="center">用于结束规则的执行和返回状态码给客户端。状态码的值可以是：204,400,402~406,408,410,411,413,416以及500~504,另外非标准状态码444,表示以不发送任何的Header头来结束连接。</td>
</tr>
<tr>
<td align="center">rewrite regex replacement flag</td>
<td align="center"></td>
<td align="center">server,location,if</td>
<td align="center">该指令根据表达式来重定向URI,或者修改字符串。指令根据配置文件中的顺序来执行。注意重写表达式只对相对路径有效。</td>
</tr>
<tr>
<td align="center">uninitialized_variable_warn on|off</td>
<td align="center">on</td>
<td align="center">http,server,location,if</td>
<td align="center">该指令用于开启和关闭未初始化变量的警告信息,默认值为开启。</td>
</tr>
<tr>
<td align="center">set  variable  value</td>
<td align="center">none</td>
<td align="center"></td>
<td align="center">该指令用于定义一个变量,并且给变量进行赋值。变量的值可以是文本、一个变量或者变量和文本的联合,文本需要用引号引起来。</td>
</tr>
</tbody></table>
<h3 id="rewrite全局变量"><a href="#rewrite全局变量" class="headerlink" title="rewrite全局变量"></a>rewrite全局变量</h3><table>
<thead>
<tr>
<th align="center">变量</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$args</td>
<td align="center">这个变量等于请求行中的参数,同$query_string</td>
</tr>
<tr>
<td align="center">$content length</td>
<td align="center">请求头中的Content-length字段</td>
</tr>
<tr>
<td align="center">$content_type</td>
<td align="center">请求头中的Content-Type字段</td>
</tr>
<tr>
<td align="center">$document_root</td>
<td align="center">当前请求在root指令中指定的值</td>
</tr>
<tr>
<td align="center">$host</td>
<td align="center">请求主机头字段,否则为服务器名称</td>
</tr>
<tr>
<td align="center">$http_user_agent</td>
<td align="center">客户端agent信息</td>
</tr>
<tr>
<td align="center">$http_cookie</td>
<td align="center">客户端cookie信息</td>
</tr>
<tr>
<td align="center">$limit_rate</td>
<td align="center">这个变量可以限制连接速率</td>
</tr>
<tr>
<td align="center">$request_method</td>
<td align="center">客户端请求的动作,通常为GET或POST</td>
</tr>
<tr>
<td align="center">$remote_addr</td>
<td align="center">客户端的IP地址</td>
</tr>
<tr>
<td align="center">$remote_port</td>
<td align="center">客户端的端口</td>
</tr>
<tr>
<td align="center">$remote_user</td>
<td align="center">已经经过Auth Basic Module验证的用户名</td>
</tr>
<tr>
<td align="center">$request_filename</td>
<td align="center">当前请求的文件路径,由root或alias指令与URI请求生成</td>
</tr>
<tr>
<td align="center">$scheme</td>
<td align="center">HTTP方法（如http,https）</td>
</tr>
<tr>
<td align="center">$server_protocol</td>
<td align="center">请求使用的协议,通常是HTTP/1.0或HTTP/1.1</td>
</tr>
<tr>
<td align="center">$server_addr</td>
<td align="center">服务器地址,在完成一次系统调用后可以确定这个值</td>
</tr>
<tr>
<td align="center">$server_name</td>
<td align="center">服务器名称</td>
</tr>
<tr>
<td align="center">$server_port</td>
<td align="center">请求到达服务器的端口号</td>
</tr>
<tr>
<td align="center">$request_uri</td>
<td align="center">包含请求参数的原始URI,不包含主机名,如”/foo/bar.php?arg=baz”</td>
</tr>
<tr>
<td align="center">$uri</td>
<td align="center">不带请求参数的当前URI,$uri不包含主机名,如”/foo/bar.html”</td>
</tr>
<tr>
<td align="center">$document_uri</td>
<td align="center">与$uri相同</td>
</tr>
</tbody></table>
<h3 id="rewrite语法规则"><a href="#rewrite语法规则" class="headerlink" title="rewrite语法规则"></a>rewrite语法规则</h3><table>
<thead>
<tr>
<th align="center">操作符</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">= ,!=</td>
<td align="center">比较的一个变量和字符串</td>
</tr>
<tr>
<td align="center">~, ~*</td>
<td align="center">与正则表达式匹配的变量,如果这个正则表达式中包含},;则整个表达式需要用”或’包围</td>
</tr>
<tr>
<td align="center">-f,!-f</td>
<td align="center">检查一个文件是否存在</td>
</tr>
<tr>
<td align="center">-d, !-d</td>
<td align="center">检查一个目录是否存在</td>
</tr>
<tr>
<td align="center">-e,!-e</td>
<td align="center">检查一个文件、目录、符号链接是否存在</td>
</tr>
<tr>
<td align="center">-x, !-x</td>
<td align="center">检查一个文件是否可执行</td>
</tr>
</tbody></table>
<h3 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a>if指令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>  语法格式</span><br><span class="line">     <span class="keyword">if</span> 空格 (条件) &#123;</span><br><span class="line">        重写模式</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 限制浏览器访问</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ Firefox) &#123; </span><br><span class="line">      rewrite ^(.*)$ /firefox/<span class="variable">$1</span> <span class="built_in">break</span>; </span><br><span class="line">    &#125;      </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ MSIE) &#123; </span><br><span class="line">        rewrite ^(.*)$ /msie/<span class="variable">$1</span> <span class="built_in">break</span>; </span><br><span class="line">    &#125;      </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ Chrome) &#123; </span><br><span class="line">        rewrite ^(.*)$ /chrome/<span class="variable">$1</span> <span class="built_in">break</span>; </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>案例：<br><img src="/2020/08/11/nginx/31.png" alt><br><img src="/2020/08/11/nginx/32.png" alt><br><img src="/2020/08/11/nginx/33.png" alt><br><img src="/2020/08/11/nginx/34.png" alt></p>
<h3 id="return指令"><a href="#return指令" class="headerlink" title="return指令"></a>return指令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制IP访问</span></span><br><span class="line"><span class="keyword">if</span>  (<span class="variable">$remote_addr</span> = 192.168.197.142) &#123;</span><br><span class="line">   <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/11/nginx/21.png" alt></p>
<h3 id="rewrite指令"><a href="#rewrite指令" class="headerlink" title="rewrite指令"></a>rewrite指令</h3><p>判断目录是否存在<br>服务器内部的rewrite和302跳转不一样.跳转的话URL都变了,变成重新http请求index.html,而内部rewrite,上下文没变</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!-e <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>) &#123;</span><br><span class="line">    rewrite ^.*$ /index.html <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set指令"><a href="#set指令" class="headerlink" title="set指令"></a>set指令</h3><p>set指令是设置变量用的,可以用来达到多条件判断时作标志用<br>判断IE并重写,且不用break;我们用set变量来达到目的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* msie) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$isie</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> = ie.html) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$isie</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$isie</span> 1) &#123;</span><br><span class="line">        rewrite ^.*$ ie.html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="常用例子"><a href="#常用例子" class="headerlink" title="常用例子"></a>常用例子</h3><p>表示访问路径有a,b,c,d都跳转到//127.0.0.1:8080$Request_uri</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> location ~^/(a|b|c|d)&#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080<span class="variable">$Request_uri</span>;</span><br><span class="line">    client_max_body_size   10240k;</span><br><span class="line">    client_body_buffer_size   128k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="实现防盗链"><a href="#实现防盗链" class="headerlink" title="实现防盗链"></a>实现防盗链</h3><p>实例：nginx服务端配置防盗链如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|png|jpeg)$ &#123;</span><br><span class="line">        valid_referers none blocked 192.168.0.23 192.168.0.123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="comment">#rewrite ^/ http://ww4.sinaimg.cn/bmiddle/051bbed1gw1egjc4xl7srj20cm08aaa6.jpg;  </span></span><br><span class="line">        <span class="built_in">return</span> 403;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注解：valid_referers可以理解为白名单。后面可以使用<em>通配符来配置白名单,例如：</em>.baidu.com都可以通过盗链访问服务器<br>none 允许客户机直接访问服务器,blocked允许通过防火墙</p>
</blockquote>
<p>客户端通过盗链访问服务端配置：编一个html文件,复制以下内容。并启动httpd服务<br>href配置成防盗链服务器的IP地址：<a href="http://192.168.0.23/index.png" target="_blank" rel="noopener">http://192.168.0.23/index.png</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>fang dao lian ce shi<span class="tag">&lt;/<span class="name">title</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">font</span> <span class="attr">size</span>=<span class="string">"5"</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://192.168.0.23/index.png"</span>&gt;</span>dao lian<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">font</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/11/nginx/51.png" alt><br><img src="/2020/08/11/nginx/52.png" alt><br><img src="/2020/08/11/nginx/53.png" alt><br><img src="/2020/08/11/nginx/54.png" alt><br><img src="/2020/08/11/nginx/55.png" alt><br><img src="/2020/08/11/nginx/56.png" alt><br><img src="/2020/08/11/nginx/57.png" alt><br><img src="/2020/08/11/nginx/58.png" alt><br><img src="/2020/08/11/nginx/59.png" alt><br><img src="/2020/08/11/nginx/60.png" alt><br><img src="/2020/08/11/nginx/61.png" alt></p>
<h2 id="Nginx负载就均衡算法"><a href="#Nginx负载就均衡算法" class="headerlink" title="Nginx负载就均衡算法"></a>Nginx负载就均衡算法</h2><p>1、轮询（默认）<br>每个请求按时间顺序逐一分配到不同的后端服务,如果后端某台服务器死机,自动剔除故障系统,使用户访问不影响<br>2、weight（轮询权值    权重）<br>Weight的值越大,分配到的访问概率越高,主要用于后端每台服务器性能不均衡的情况下,或者仅仅为在主从的情况下设置不同的权值,达到合理有效的利用主机资源<br>3、ip_hash<br>每个请求按访问的IP的哈希结果分配,使来自同一个IP的访客固定访问一台后端服务器,并且可以有效解决动态网页存在的session共享问题</p>
<h3 id="轮询-默认"><a href="#轮询-默认" class="headerlink" title="轮询(默认)"></a>轮询(默认)</h3><p>每个请求按时间顺序逐一分配到不同的后端服务器,如果后端服务器down掉,能自动删除<br><img src="/2020/08/11/nginx/71.png" alt><br><img src="/2020/08/11/nginx/72.png" alt><br><img src="/2020/08/11/nginx/73.png" alt><br><img src="/2020/08/11/nginx/74.png" alt><br><img src="/2020/08/11/nginx/75.png" alt><br><img src="/2020/08/11/nginx/76.png" alt></p>
<h3 id="权重-weight"><a href="#权重-weight" class="headerlink" title="权重(weight)"></a>权重(weight)</h3><p>指定轮询几率,weight和访问比率成正比,用于后端服务器性能不均的情况<br>复制代码代码如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream bakend &#123;  </span><br><span class="line">server 192.168.0.14 weight=3;  </span><br><span class="line">server 192.168.0.15 weight=1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/11/nginx/81.png" alt><br><img src="/2020/08/11/nginx/82.png" alt><br><img src="/2020/08/11/nginx/83.png" alt></p>
<h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h3><p>每个请求按访问ip的hash结果分配,这样每个访客固定访问一个后端服务器,可以解决session的问题<br>复制代码代码如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream bakend &#123;  </span><br><span class="line">ip_hash;  </span><br><span class="line">server 192.168.0.14:88;  </span><br><span class="line">server 192.168.0.15:80;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/11/nginx/91.png" alt><br><img src="/2020/08/11/nginx/92.png" alt><br><img src="/2020/08/11/nginx/93.png" alt><br><img src="/2020/08/11/nginx/94.png" alt></p>
<h2 id="nginx负载均衡调度状态"><a href="#nginx负载均衡调度状态" class="headerlink" title="nginx负载均衡调度状态"></a>nginx负载均衡调度状态</h2><p>在nginx upstream模块中,可以设定每台后端服务器在负载均衡调度中的状态,常用状态有<br>down: 表示当前的server暂时不参与负载均衡<br><img src="/2020/08/11/nginx/95.png" alt><br><img src="/2020/08/11/nginx/96.png" alt><br><img src="/2020/08/11/nginx/97.png" alt></p>
<p>Backup: 预留的备份及其,当其他所有的非backup及其出现故障或者忙的时候,才会请求backup机器,因此这台及其的访问压力最低<br><img src="/2020/08/11/nginx/100.png" alt><br><img src="/2020/08/11/nginx/101.png" alt><br><img src="/2020/08/11/nginx/102.png" alt></p>
<p>Max_fails: 允许请求失败的次数,默认为1,当超过最大次数后,返回proxy_next_upstream模块定义的错误</p>
<p>Fail_timeout: 请求失败超时时间,在经历了max_fails次失败后暂停服务时间,max_fails和fail_timeout可以一起使用</p>
<h2 id="获取数据源地址"><a href="#获取数据源地址" class="headerlink" title="获取数据源地址"></a>获取数据源地址</h2><p>具体配置过程如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream linux &#123; </span><br><span class="line">      server 10.0.6.108:7080; </span><br><span class="line">      server 10.0.0.85:8980; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将server节点下的location节点中的proxy_pass配置为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">location / &#123; </span><br><span class="line">            root  html; </span><br><span class="line">            index  index.html index.htm; </span><br><span class="line">            proxy_pass http://linuxidc;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header REMOTE-HOST <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">注解：</span><br><span class="line">            ＃代理到upstream定义的服务地址池</span><br><span class="line">            proxy_pass http://linuxidc;</span><br><span class="line">            ＃获取数据源地址</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            ＃获取到远程主机地址</span><br><span class="line">            proxy_set_header REMOTE-HOST <span class="variable">$remote_addr</span>;</span><br><span class="line">            ＃让服务端获取真实客户端地址</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/08/11/nginx/111.png" alt><br><img src="/2020/08/11/nginx/112.png" alt><br><img src="/2020/08/11/nginx/113.png" alt><br><img src="/2020/08/11/nginx/114.png" alt><br><img src="/2020/08/11/nginx/115.png" alt><br><img src="/2020/08/11/nginx/116.png" alt><br><img src="/2020/08/11/nginx/117.png" alt><br><img src="/2020/08/11/nginx/118.png" alt><br><img src="/2020/08/11/nginx/119.png" alt><br><img src="/2020/08/11/nginx/120.png" alt><br><img src="/2020/08/11/nginx/121.png" alt><br><img src="/2020/08/11/nginx/122.png" alt><br><img src="/2020/08/11/nginx/123.png" alt></p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>版权声明： </strong>
              本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://yoursite.com/2020/08/11/nginx/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2020/08/20/ipv6/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            阿里云服务器如何设置IPV6通过appstore的审核
          
        </div>
      </a>
    
    
      <a href="/2020/08/10/nginx-diff-apache/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Nginx 和 Apache 各有什么优缺点</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '',
        app_key: '',
        path: window.location.pathname,
        notify: 'false',
        verify: 'false',
        avatar: 'monsterid',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2019-2021
        <i class="ri-heart-fill heart_icon"></i> XIN LONG
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="我在人间凑数的日子"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Subtitle -->

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
    console.log(err)
  }
</script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->


<script src="/js/clickLove.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>



    
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>